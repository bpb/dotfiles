#!/usr/bin/env bash
set -euo pipefail
[[ "{{ if .profile.dev }}1{{ else }}0{{ end }}" = "1" ]] || exit 0
SERVICE="openai_api_key"
ACCOUNT="${USER}"
KEY_URL="https://platform.openai.com/account/api-keys"

# If OPENAI_API_KEY is provided via env, prefer that (non-interactive).
if [[ -n "${OPENAI_API_KEY:-}" ]]; then
  security add-generic-password -a "${ACCOUNT}" -s "${SERVICE}" -w "${OPENAI_API_KEY}" -U >/dev/null
  exit 0
fi

# Skip if already present
if security find-generic-password -a "${ACCOUNT}" -s "${SERVICE}" >/dev/null 2>&1; then
  exit 0
fi

printf "\033[1;33m[openai]\033[0m No API key found in Keychain.\n"
printf "â†’ You can create one here: %s\n" "$KEY_URL"

# Try to launch browser if on macOS
if command -v open >/dev/null 2>&1; then
  open "$KEY_URL"
fi

printf "Enter OpenAI API key (starts with 'sk-'): "
read -r KEY
if [[ -n "${KEY}" ]]; then
  security add-generic-password -a "${ACCOUNT}" -s "${SERVICE}" -w "${KEY}" -U >/dev/null
  printf "\033[1;32m[openai]\033[0m saved to Keychain.\n"
else
  printf "\033[1;33m[openai]\033[0m no key entered; skipping.\n"
fi
